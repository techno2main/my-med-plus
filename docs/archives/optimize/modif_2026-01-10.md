# Modifications du 10 janvier 2026

## RÃ©sumÃ©

Cette session a implÃ©mentÃ© un systÃ¨me complet de gestion de fin de traitement comprenant :
- Un bouton "Terminer" pour arrÃªter manuellement un traitement avant sa date de fin
- Un archivage automatique des traitements expirÃ©s au dÃ©marrage de l'application
- Une correction de la gÃ©nÃ©ration des prises (intakes) pour respecter la date de dÃ©but du traitement

---

## 1. Migration SQL

### Fichier : `supabase/migrations/xxx.sql`

### 1.1 Nouvelle fonction `auto_archive_expired_treatments()`

**Objectif** : Archiver automatiquement les traitements dont la date de fin est dÃ©passÃ©e.

```sql
CREATE OR REPLACE FUNCTION public.auto_archive_expired_treatments()
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  archived_count INTEGER;
BEGIN
  UPDATE treatments
  SET 
    is_active = false,
    updated_at = NOW()
  WHERE is_active = true
    AND end_date IS NOT NULL
    AND end_date < CURRENT_DATE;
  
  GET DIAGNOSTICS archived_count = ROW_COUNT;
  RETURN archived_count;
END;
$$;
```

**Comportement** :
- Passe `is_active` Ã  `false` pour tous les traitements actifs dont `end_date < CURRENT_DATE`
- Retourne le nombre de traitements archivÃ©s
- Le trigger existant `cleanup_pending_intakes_on_archive` supprime automatiquement les prises `pending` futures

### 1.2 AmÃ©lioration de `regenerate_future_intakes()`

**ProblÃ¨me corrigÃ©** : Les prises Ã©taient gÃ©nÃ©rÃ©es Ã  partir de `CURRENT_DATE` mÃªme si `start_date` du traitement Ã©tait dans le futur.

**Solution** : Utiliser `GREATEST(CURRENT_DATE, treatment_start_date)` comme point de dÃ©part.

```sql
-- Nouvelle variable
treatment_start_date DATE;

-- RÃ©cupÃ©ration de start_date
SELECT m.times, m.is_paused, t.end_date, t.start_date, t.is_active 
INTO md_times, med_is_paused, treatment_end_date, treatment_start_date, treatment_active
FROM medications m
JOIN treatments t ON m.treatment_id = t.id
WHERE m.id = med_id;

-- Calcul du point de dÃ©part
start_from_date := GREATEST(CURRENT_DATE, treatment_start_date);

-- GÃ©nÃ©ration Ã  partir de start_from_date
FOR i IN 0..6 LOOP
  intake_date := start_from_date + (i || ' days')::INTERVAL;
  -- ...
END LOOP;
```

**RÃ©sultat** :
- Si `start_date` est dans le passÃ© â†’ gÃ©nÃ©ration Ã  partir d'aujourd'hui
- Si `start_date` est dans le futur â†’ gÃ©nÃ©ration Ã  partir de `start_date`

---

## 2. Nouveaux fichiers crÃ©Ã©s

### 2.1 `src/pages/treatments/hooks/useTerminateTreatment.ts`

**Objectif** : Hook pour terminer manuellement un traitement.

```typescript
import { useState } from "react"
import { supabase } from "@/integrations/supabase/client"
import { toast } from "sonner"

export const useTerminateTreatment = () => {
  const [isTerminating, setIsTerminating] = useState(false)

  const terminateTreatment = async (treatmentId: string, treatmentName: string) => {
    setIsTerminating(true)
    try {
      const today = new Date().toISOString().split('T')[0]
      
      const { error } = await supabase
        .from("treatments")
        .update({ 
          is_active: false, 
          end_date: today,
          updated_at: new Date().toISOString() 
        })
        .eq("id", treatmentId)

      if (error) throw error

      toast.success(`Traitement "${treatmentName}" terminÃ©`)
      return true
    } catch (error) {
      console.error("Error terminating treatment:", error)
      toast.error("Erreur lors de la terminaison du traitement")
      return false
    } finally {
      setIsTerminating(false)
    }
  }

  return { terminateTreatment, isTerminating }
}
```

**FonctionnalitÃ©s** :
- Met `is_active` Ã  `false`
- Met `end_date` Ã  la date du jour
- Le trigger `cleanup_pending_intakes_on_archive` supprime les prises futures automatiquement

### 2.2 `src/hooks/useAutoArchiveTreatments.ts`

**Objectif** : Archiver automatiquement les traitements expirÃ©s au dÃ©marrage de l'app.

```typescript
import { useEffect, useRef } from "react"
import { supabase } from "@/integrations/supabase/client"

export const useAutoArchiveTreatments = () => {
  const hasRun = useRef(false)

  useEffect(() => {
    if (hasRun.current) return
    hasRun.current = true

    const archiveExpiredTreatments = async () => {
      try {
        const { data, error } = await supabase.rpc("auto_archive_expired_treatments")
        
        if (error) {
          console.error("Auto-archive error:", error)
          return
        }

        if (data && data > 0) {
          console.log(`Auto-archived ${data} expired treatment(s)`)
        }
      } catch (error) {
        console.error("Auto-archive exception:", error)
      }
    }

    archiveExpiredTreatments()
  }, [])
}
```

**CaractÃ©ristiques** :
- ExÃ©cution unique au montage de l'app (via `useRef`)
- Appel silencieux (pas de toast, juste un log console)
- 100% gratuit (pas de cron job Supabase payant)

---

## 3. Fichiers modifiÃ©s

### 3.1 `src/App.tsx`

**Modification** : Import et utilisation du hook `useAutoArchiveTreatments`.

```typescript
// Ajout de l'import
import { useAutoArchiveTreatments } from "./hooks/useAutoArchiveTreatments";

const App = () => {
  useAutoRegenerateIntakes();
  useAutoArchiveTreatments(); // Nouveau
  // ...
}
```

### 3.2 `src/pages/treatments/Treatments.tsx`

**Modification** : Passage du callback `onTreatmentTerminated` au `TreatmentCard`.

```typescript
// Avant
const { treatments, loading } = useTreatmentsList()

// AprÃ¨s
const { treatments, loading, reloadTreatments } = useTreatmentsList()

// Dans le rendu
<TreatmentCard 
  key={treatment.id} 
  treatment={treatment} 
  onTreatmentTerminated={reloadTreatments}  // Nouveau
/>
```

### 3.3 `src/pages/treatments/components/TreatmentCard.tsx`

**Modifications majeures** :

#### Nouveaux imports
```typescript
import { Archive } from "lucide-react"
import { useTerminateTreatment } from "../hooks/useTerminateTreatment"
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog"
```

#### Nouvelle prop
```typescript
interface TreatmentCardProps {
  treatment: Treatment
  onTreatmentTerminated?: () => void  // Nouveau
}
```

#### Nouveaux Ã©tats et hooks
```typescript
const [showTerminateDialog, setShowTerminateDialog] = useState(false)
const { terminateTreatment, isTerminating } = useTerminateTreatment()
```

#### Nouveau bouton "Terminer"
```tsx
{treatment.is_active && (
  <div className="flex gap-2">
    <Button 
      variant="outline" 
      size="sm" 
      onClick={() => setShowTerminateDialog(true)}
      className="text-amber-700 border-amber-300 hover:bg-amber-50"
    >
      <Archive className="h-4 w-4 mr-1" />
      Terminer
    </Button>
    <Button variant="ghost" size="sm" onClick={() => navigate(`/treatments/${treatment.id}/edit`)}>
      Modifier
    </Button>
  </div>
)}
```

#### Dialog de confirmation
```tsx
<AlertDialog open={showTerminateDialog} onOpenChange={setShowTerminateDialog}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Terminer ce traitement ?</AlertDialogTitle>
      <AlertDialogDescription className="space-y-2">
        <p>
          Cette action mettra fin au traitement <strong>{treatment.name}</strong> 
          avant sa date de fin prÃ©vue ({formatToFrenchDate(treatment.end_date)}).
        </p>
        <p className="text-amber-600 font-medium">
          âš ï¸ Toutes les prises de mÃ©dicaments futures seront supprimÃ©es.
        </p>
        <p className="text-muted-foreground text-sm">
          Cette action est irrÃ©versible.
        </p>
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel disabled={isTerminating}>Annuler</AlertDialogCancel>
      <AlertDialogAction 
        onClick={handleConfirmTerminate}
        disabled={isTerminating}
        className="bg-amber-600 hover:bg-amber-700"
      >
        {isTerminating ? "Terminaison..." : "Confirmer"}
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

### 3.4 `src/pages/treatments/components/MedicationItem.tsx`

**Modification** : Style du badge "TerminÃ©" pour les traitements archivÃ©s.

```typescript
// Avant
<Badge variant="secondary" className="text-xs">
  TerminÃ©
</Badge>

// AprÃ¨s
<Badge variant="secondary" className="text-xs bg-amber-100 text-amber-700 border-amber-200">
  TerminÃ©
</Badge>
```

---

## 4. Flux utilisateur final

### 4.1 Terminaison manuelle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TRAITEMENT ACTIF                                           â”‚
â”‚  DT2-CHL-2026                     [Terminer] [Modifier]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ Clic "Terminer"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ Terminer ce traitement ?                                â”‚
â”‚                                                              â”‚
â”‚  Cette action mettra fin au traitement DT2-CHL-2026         â”‚
â”‚  avant sa date de fin prÃ©vue (05/04/2026).                  â”‚
â”‚                                                              â”‚
â”‚  âš ï¸ Toutes les prises futures seront supprimÃ©es.            â”‚
â”‚  Cette action est irrÃ©versible.                             â”‚
â”‚                                                              â”‚
â”‚                    [Annuler]  [Confirmer]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ Confirmation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TRAITEMENT ARCHIVÃ‰                                         â”‚
â”‚  DT2-CHL-2026                                    [ğŸ‘]       â”‚
â”‚  [ArchivÃ©]                                                  â”‚
â”‚  â”œâ”€ Xigduo â€¢ 5mg/1000mg                        [TerminÃ©]    â”‚
â”‚  â””â”€ Quviviq â€¢ 50mg                             [TerminÃ©]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Archivage automatique

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OUVERTURE DE L'APP                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. useAutoArchiveTreatments() s'exÃ©cute                     â”‚
â”‚  2. Appel de supabase.rpc("auto_archive_expired_treatments") â”‚
â”‚  3. Traitements avec end_date < aujourd'hui â†’ is_active=falseâ”‚
â”‚  4. Trigger cleanup â†’ suppression prises pending futures     â”‚
â”‚  5. L'utilisateur voit l'Ã©tat correct immÃ©diatement          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Impact sur les donnÃ©es existantes

| Ã‰lÃ©ment | Impact |
|---------|--------|
| Traitements existants | âœ… Aucun changement (sauf archivage auto si expirÃ©s) |
| Prises existantes | âœ… Aucun changement |
| Stocks | âœ… Aucun changement |
| Historique | âœ… Aucun changement |
| Nouveaux traitements | âœ… Intakes gÃ©nÃ©rÃ©es depuis MAX(today, start_date) |

---

## 6. Triggers existants utilisÃ©s

| Trigger | Table | Ã‰vÃ©nement | Action |
|---------|-------|-----------|--------|
| `cleanup_pending_intakes_on_archive` | `treatments` | UPDATE (is_active: trueâ†’false) | Supprime les prises `pending` futures |
| `auto_regenerate_intakes_on_times_change` | `medications` | INSERT/UPDATE | RÃ©gÃ©nÃ¨re les prises si `times` change |

---

## 7. CoÃ»ts Supabase

**Aucun coÃ»t supplÃ©mentaire** :
- Pas de cron job (pg_cron payant)
- Pas d'Edge Function supplÃ©mentaire
- Simple appel RPC au dÃ©marrage de l'app

---

## 8. Fichiers crÃ©Ã©s/modifiÃ©s - RÃ©capitulatif

| Fichier | Action |
|---------|--------|
| `src/pages/treatments/hooks/useTerminateTreatment.ts` | âœ¨ CrÃ©Ã© |
| `src/hooks/useAutoArchiveTreatments.ts` | âœ¨ CrÃ©Ã© |
| `src/App.tsx` | ğŸ“ ModifiÃ© |
| `src/pages/treatments/Treatments.tsx` | ğŸ“ ModifiÃ© |
| `src/pages/treatments/components/TreatmentCard.tsx` | ğŸ“ ModifiÃ© |
| `src/pages/treatments/components/MedicationItem.tsx` | ğŸ“ ModifiÃ© |
| Migration SQL | âœ¨ CrÃ©Ã© (auto_archive + fix regenerate_future_intakes) |
